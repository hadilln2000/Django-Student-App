name: Python CI and Deploy to Render

on: 
  push:
    branches: [ master ]       
  pull_request:
    branches: [ master ]       

jobs: 
  build-and-deploy:
    runs-on: ubuntu-latest      

    steps: 
    # Step 1: Downloads the code from GitHub
    - uses: actions/checkout@v3 

    # Step 2: Builds the Docker image using your Dockerfile
    - name: Build Docker image 
      run: docker build -t django-app . 

    # Step 3: Runs database migrations 
    - name: Run Migrations
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        python manage.py migrate

    # Step 4: Deploys to Render using the Service ID and API Key
    - name: Deploy to Render 
      uses: johnbeynon/render-deploy-action@v0.0.8 
      with:
        api-key: ${{ secrets.RENDER_API_KEY }}
        service-id: ${{ secrets.DJANGO_SERVICE_ID }}